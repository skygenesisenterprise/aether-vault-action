name: Aether Vault Action Release

on:
  push:
    tags:
      - "v*.*.*-action"

jobs:
  release:
    name: Create Action Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        working-directory: package/action
        run: |
          go mod download
          go mod tidy

      - name: Run tests
        working-directory: package/action
        run: go test -v ./...

      - name: Run code quality checks
        working-directory: package/action
        run: |
          go fmt ./...
          go vet ./...

      - name: Build binaries
        working-directory: package/action
        run: make build

      - name: Create release archive
        working-directory: package/action
        run: make release

      - name: Extract tag version
        id: version
        run: |
          TAG=${{ github.ref_name }}
          VERSION=${TAG%-action}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "docker_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: package/action
          file: package/action/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            skygenesisenterprise/aether-vault:latest
            skygenesisenterprise/aether-vault:${{ steps.version.outputs.docker_version }}
          labels: |
            org.opencontainers.image.title=Aether Vault Action
            org.opencontainers.image.description=Enterprise-Ready GitHub Action for Secure Aether Vault Authentication
            org.opencontainers.image.vendor=Sky Genesis Enterprise
            org.opencontainers.image.version=${{ steps.version.outputs.docker_version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate Docker image SBOM
        uses: anchore/sbom-action@v0
        with:
          image: skygenesisenterprise/aether-vault:${{ steps.version.outputs.docker_version }}
          format: spdx-json
          output-file: package/action/sbom.spdx.json

      - name: Run Docker security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: skygenesisenterprise/aether-vault:${{ steps.version.outputs.docker_version }}
          format: "sarif"
          output: "package/action/trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "package/action/trivy-results.sarif"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Aether Vault Action ${{ steps.version.outputs.version }}
          body: |
            ## Aether Vault Action ${{ steps.version.outputs.version }}

            ### üöÄ Features
            - Authenticate with Aether Vault using GitHub OIDC
            - Perform security policy checks
            - Support for multiple platforms (Linux, macOS)
            - Multi-architecture support (amd64, arm64)
            - **NEW**: Docker container support for enterprise deployments

            ### üì¶ Installation

            #### GitHub Action
            ```yaml
            - name: Aether Vault Action
              uses: skygenesisenterprise/aether-vault@${{ steps.version.outputs.tag }}
              with:
                vault-url: ${{ secrets.VAULT_URL }}
                auth-method: github-oidc
                role: your-vault-role
            ```

            #### Docker Container
            ```bash
            # Pull the image
            docker pull skygenesisenterprise/aether-vault:${{ steps.version.outputs.docker_version }}

            # Run with environment variables
            docker run --rm \
              -e VAULT_URL="https://your-vault.com" \
              -e ROLE="your-role" \
              skygenesisenterprise/aether-vault:${{ steps.version.outputs.docker_version }}
            ```

            #### Docker Compose
            ```yaml
            services:
              aether-vault:
                image: skygenesisenterprise/aether-vault:${{ steps.version.outputs.docker_version }}
                environment:
                  VAULT_URL: ${VAULT_URL}
                  ROLE: ${ROLE}
                  POLICY_MODE: enforce
            ```

            ### üîß Usage
            See [USAGE_EXAMPLES.md](https://github.com/skygenesisenterprise/aether-vault/blob/main/package/action/USAGE_EXAMPLES.md) for detailed examples.

            ### üê≥ Docker Information
            - **Multi-architecture**: linux/amd64, linux/arm64
            - **Base image**: Alpine Linux (minimal, secure)
            - **Security scanned**: Trivy vulnerability assessment
            - **SBOM included**: Software Bill of Materials
            - **Non-root user**: Security-hardened runtime

            ### üìã Changes
            - Built from tag ${{ steps.version.outputs.tag }}
            - Includes all platform binaries
            - Full test coverage and security checks
            - **NEW**: Docker image with multi-architecture support
            - **NEW**: Security scanning and SBOM generation

          files: |
            package/action/release/*.tar.gz
            package/action/LICENSE
            package/action/README.md
            package/action/action.yml
            package/action/sbom.spdx.json
            package/action/trivy-results.sarif
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Update action version in action.yml
        working-directory: package/action
        run: |
          # Update version reference if needed
          sed -i "s|uses: .*/.*@.*|uses: skygenesis/aether-vault@${{ steps.version.outputs.tag }}|g" README.md || true

      - name: Notify completion
        run: |
          echo "‚úÖ Action release completed successfully!"
          echo "üè∑Ô∏è  Tag: ${{ steps.version.outputs.tag }}"
          echo "üì¶ Version: ${{ steps.version.outputs.version }}"
          echo "üê≥ Docker Image: skygenesisenterprise/aether-vault:${{ steps.version.outputs.docker_version }}"
          echo "üîó Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo "üê≥ Docker Hub: https://hub.docker.com/r/skygenesisenterprise/aether-vault/tags"
