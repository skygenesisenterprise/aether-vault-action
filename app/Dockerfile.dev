# Development Dockerfile for Aether Vault Action
FROM golang:1.25.5-alpine AS development

# Install development dependencies
RUN apk add --no-cache \
    git \
    ca-certificates \
    tzdata \
    curl \
    jq \
    vim \
    bash \
    make

# Create app user
RUN addgroup -g 1001 -S aether && \
    adduser -u 1001 -S aether -G aether

# Set working directory
WORKDIR /app

# Copy go files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download && go mod tidy

# Copy source code
COPY . .

# Build the binary
RUN CGO_ENABLED=0 go build \
    -ldflags='-w -s' \
    -o bin/aether-vault-linux-amd64 \
    ./cmd

# Make binary executable
RUN chmod +x bin/aether-vault-linux-amd64

# Create necessary directories
RUN mkdir -p /github/workspace && \
    mkdir -p /app/logs && \
    chown -R aether:aether /app /github

# Switch to non-root user
USER aether

# Set environment variables
ENV LOG_LEVEL=debug
ENV GO111MODULE=on
ENV CGO_ENABLED=0

# Set PATH
ENV PATH="/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/app/bin"

# Expose ports
EXPOSE 8080

# Default command
CMD ["./bin/aether-vault-linux-amd64"]