# Docker Makefile for Aether Vault Action
.PHONY: docker-build docker-run docker-stop docker-clean docker-dev docker-test docker-logs docker-health

# Docker configuration
IMAGE_NAME=skygenesisenterprise/aether-vault-action
IMAGE_TAG=latest
CONTAINER_NAME=aether-vault-action
DEV_CONTAINER_NAME=aether-vault-action-dev

# Build arguments
TARGETOS=linux
TARGETARCH=amd64

# Default target
docker-help:
	@echo "Available Docker commands:"
	@echo "  docker-build     - Build Docker image"
	@echo "  docker-run       - Run container in production mode"
	@echo "  docker-dev       - Run container in development mode"
	@echo "  docker-stop      - Stop running containers"
	@echo "  docker-clean     - Clean up containers and images"
	@echo "  docker-test      - Run tests in container"
	@echo "  docker-logs      - Show container logs"
	@echo "  docker-health    - Check container health"
	@echo "  docker-push      - Push image to registry"
	@echo "  docker-pull      - Pull image from registry"

# Build Docker image
docker-build:
	@echo "ğŸ”¨ Building Docker image..."
	docker build \
		--build-arg TARGETOS=$(TARGETOS) \
		--build-arg TARGETARCH=$(TARGETARCH) \
		-t $(IMAGE_NAME):$(IMAGE_TAG) \
		-f Dockerfile \
		.
	@echo "âœ… Docker image built successfully: $(IMAGE_NAME):$(IMAGE_TAG)"

# Build development image
docker-build-dev:
	@echo "ğŸ”¨ Building development Docker image..."
	docker build \
		--target development \
		-t $(IMAGE_NAME):dev \
		-f Dockerfile.dev \
		.
	@echo "âœ… Development Docker image built successfully: $(IMAGE_NAME):dev"

# Run container with docker-compose
docker-run:
	@echo "ğŸš€ Starting Aether Vault Action with docker-compose..."
	docker-compose up -d
	@echo "âœ… Container started successfully"
	@echo "ğŸ“Š Check status with: make docker-health"
	@echo "ğŸ“‹ View logs with: make docker-logs"

# Run development container
docker-dev: docker-build-dev
	@echo "ğŸš€ Starting development container..."
	docker-compose --profile dev up -d dev-service
	@echo "âœ… Development container started"
	@echo "ğŸ”§ Access container with: docker exec -it $(DEV_CONTAINER_NAME) bash"

# Stop containers
docker-stop:
	@echo "ğŸ›‘ Stopping containers..."
	docker-compose down
	@echo "âœ… Containers stopped"

# Clean up containers and images
docker-clean:
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker-compose down -v --remove-orphans
	docker image prune -f
	docker system prune -f
	@echo "âœ… Docker cleanup completed"

# Run tests in container
docker-test: docker-build-dev
	@echo "ğŸ§ª Running tests in container..."
	docker run --rm \
		--name $(CONTAINER_NAME)-test \
		-v $(PWD):/app \
		-w /app \
		$(IMAGE_NAME):dev \
		go test -v ./...
	@echo "âœ… Tests completed"

# Show container logs
docker-logs:
	@echo "ğŸ“‹ Showing container logs..."
	docker-compose logs -f

# Check container health
docker-health:
	@echo "ğŸ¥ Checking container health..."
	docker-compose ps
	@echo ""
	@echo "ğŸ“Š Health status:"
	docker inspect --format='{{.Name}} - {{.State.Status}} - {{.State.Health.Status}}' $(CONTAINER_NAME) 2>/dev/null || echo "Container not running"

# Push image to registry
docker-push: docker-build
	@echo "ğŸ“¤ Pushing image to registry..."
	docker push $(IMAGE_NAME):$(IMAGE_TAG)
	@echo "âœ… Image pushed successfully"

# Pull image from registry
docker-pull:
	@echo "ğŸ“¥ Pulling image from registry..."
	docker pull $(IMAGE_NAME):$(IMAGE_TAG)
	@echo "âœ… Image pulled successfully"

# Enter container shell
docker-shell:
	@echo "ğŸš Entering container shell..."
	docker exec -it $(CONTAINER_NAME) /bin/bash

# Enter development container shell
docker-shell-dev:
	@echo "ğŸš Entering development container shell..."
	docker exec -it $(DEV_CONTAINER_NAME) /bin/bash

# Restart containers
docker-restart:
	@echo "ğŸ”„ Restarting containers..."
	docker-compose restart
	@echo "âœ… Containers restarted"

# Update containers
docker-update:
	@echo "ğŸ”„ Updating containers..."
	docker-compose pull
	docker-compose up -d
	@echo "âœ… Containers updated"

# Show container stats
docker-stats:
	@echo "ğŸ“Š Container resource usage:"
	docker stats $(CONTAINER_NAME)

# Backup container data
docker-backup:
	@echo "ğŸ’¾ Creating container backup..."
	docker run --rm \
		-v $(PWD)/output:/backup \
		-v aether-vault-output:/data \
		alpine:latest \
		tar czf /backup/backup-$(shell date +%Y%m%d-%H%M%S).tar.gz -C /data .
	@echo "âœ… Backup created"

# Restore container data
docker-restore:
	@echo "ğŸ“¥ Restoring container backup..."
	@echo "Please specify backup file: make docker-restore BACKUP=backup-file.tar.gz"
	@if [ -n "$(BACKUP)" ]; then \
		docker run --rm \
			-v $(PWD)/$(BACKUP):/backup \
			-v aether-vault-output:/data \
			alpine:latest \
			tar xzf /backup -C /data; \
		echo "âœ… Backup restored"; \
	else \
		echo "âŒ No backup file specified"; \
	fi

# Show Docker information
docker-info:
	@echo "ğŸ³ Docker Information:"
	@echo "Image: $(IMAGE_NAME):$(IMAGE_TAG)"
	@echo "Container: $(CONTAINER_NAME)"
	@echo "Target OS: $(TARGETOS)"
	@echo "Target Arch: $(TARGETARCH)"
	@echo ""
	@echo "ğŸ“‹ Docker version:"
	@docker --version
	@echo ""
	@echo "ğŸ“‹ Docker Compose version:"
	@docker-compose --version