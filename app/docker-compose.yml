version: "3.8"

services:
  # Aether Vault Action Service
  aether-vault:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGETOS: linux
        TARGETARCH: amd64
      target: final
    image: skygenesisenterprise/aether-vault:latest
    container_name: aether-vault
    restart: unless-stopped

    # Environment variables
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - VAULT_URL=${VAULT_URL:-https://vault.skygenesisenterprise.com}
      - AUTH_METHOD=${AUTH_METHOD:-github-oidc}
      - ROLE=${ROLE:-demo-role}
      - POLICY_MODE=${POLICY_MODE:-enforce}
      - AUDIENCE=${AUDIENCE:-aether-vault}
      - ALLOW_TOKEN_OUTPUT=${ALLOW_TOKEN_OUTPUT:-false}

      # GitHub Actions simulation environment
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-skygenesisenterprise/aether-vault}
      - GITHUB_REF=${GITHUB_REF:-refs/heads/main}
      - GITHUB_SHA=${GITHUB_SHA:-demo-sha}
      - GITHUB_WORKFLOW=${GITHUB_WORKFLOW:-demo-workflow}
      - GITHUB_ACTION=${GITHUB_ACTION:-aether-vault}
      - GITHUB_ACTOR=${GITHUB_ACTOR:-demo-user}
      - ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL:-https://token.actions.githubusercontent.com}
      - ACTIONS_ID_TOKEN_REQUEST_TOKEN=${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-demo-token}

    # Volumes
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./output:/github/workspace
      - ./bin:/app/bin:ro

    # Ports (for future web interface)
    ports:
      - "8080:8080"

    # Networks
    networks:
      - aether-network

    # Health check
    healthcheck:
      test: ["CMD", "aether-vault", "--help"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Security options
    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 64M

  # Mock Vault Service (for development/testing)
  mock-vault:
    image: nginx:alpine
    container_name: mock-vault
    restart: unless-stopped

    # Configuration for mock Vault
    volumes:
      - ./mock-vault/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./mock-vault/html:/usr/share/nginx/html:ro

    ports:
      - "8200:8200"

    networks:
      - aether-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200/v1/sys/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Development Service (for testing)
  dev-service:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: development
    image: skygenesisenterprise/aether-vault-action:dev
    container_name: aether-vault-action-dev
    restart: "no"

    environment:
      - LOG_LEVEL=debug
      - VAULT_URL=http://mock-vault:8200
      - AUTH_METHOD=github-oidc
      - ROLE=dev-role
      - POLICY_MODE=audit
      - AUDIENCE=aether-vault
      - ALLOW_TOKEN_OUTPUT=true

    volumes:
      - .:/app
      - /app/bin # Exclude bin directory from mount
      - ./logs:/app/logs
      - ./output:/github/workspace

    networks:
      - aether-network

    # Override entrypoint for development
    entrypoint: ["tail", "-f", "/dev/null"]

    profiles:
      - dev

networks:
  aether-network:
    driver: bridge
    name: aether-vault-network
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  logs:
    driver: local
    name: aether-vault-logs
  output:
    driver: local
    name: aether-vault-output
  config:
    driver: local
    name: aether-vault-config
